@model zapread.com.Models.Database.Post
@{
    ViewBag.Title = "Edit Post";
}
<div class="wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <br />
        <h2>Edit Post</h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Group")">Groups</a></li>
            <li class="breadcrumb-item"><a id="groupLink" href="@Url.Action("GroupDetail", "Group", new { id = Model.Group.GroupId })">@Model.Group.GroupName</a></li>
            <li class="breadcrumb-item active">Edit</li>
        </ol>
    </div>
    <div class="col-lg-2">
    </div>
</div>
<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-sm-2">
        </div>
        <div class="col-lg-8">
            <div id="postEdit" class="ibox float-e-margins">
                <div class="ibox-title">
                    <h3>
                        <img class="img-circle" src="@Url.Action("UserImage", "Home", new {size = 30})" /> @User.Identity.Name : Edit Post
                    </h3>
                </div>
                <div class="ibox-content no-padding">
                    <div class="sk-spinner sk-spinner-three-bounce">
                        <div class="sk-bounce1"></div>
                        <div class="sk-bounce2"></div>
                        <div class="sk-bounce3"></div>
                    </div>
                    <div class="wrapper p-md">
                        <form>
                            <div class="form-group">
                                <label>Post Title</label>
                                <input id="postTitle" type="text" class="form-control" value="@Model.PostTitle" placeholder="Post Title (Optional)">
                            </div>
                            <div id="editGroup" class="form-group" style="display:none;">
                                <label>Post Group</label>
                                <input id="postGroup" type="text" class="form-control" value="@Model.Group.GroupName" />
                            </div>
                            <div id="changeGroupBtn" class="form-group">
                                <a href="javascript:void(0);" class="btn btn-warning btn-sm" onclick="changeGroup();">Change Group</a>
                            </div>
                        </form>
                    </div>
                    <div id="progressUpload" class="progress" style="display:none">
                        <div id="progressUploadBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%">
                        </div>
                    </div>
                    <div class="sticky-top sticky-offset" id="editorToolbar"></div>
                    <div class="click2edit wrapper p-md" style="min-height: 50px;">
                        @Html.Raw(Model.Content)
                    </div>
                </div>
                <div class="ibox-footer">
                    <div class="row text-right">
                        <div class="col-sm-8"></div>
                        <div class="col-sm-4 text-right">
                            <button id="edit" class="btn btn-secondary btn-sm m-l-sm" onclick="edit();" type="button">Edit</button>
                            <button id="save" class="btn btn-secondary btn-sm" onclick="save(@Model.PostId,gid,'@Model.UserId.AppId',true);" type="button">Preview (Save Draft)</button>
                            <button id="submit" class="btn btn-primary btn-sm" onclick="submit(@Model.PostId,gid,'@Model.UserId.AppId',true);" type="button">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-2">
        </div>
        <div class="col-lg-8">
            <div class="ibox-title">
                <h3>
                    Your Saved Drafts
                </h3>
            </div>
            <div class="ibox-content no-padding">
                <div class="wrapper p-md">
                    <table id="draftsTable" class="table table-striped" style="width:100%">
                        <thead>
                            <tr>
                                <th>Post title</th>
                                <th>Group</th>
                                <th>Last Edited</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    @Styles.Render("~/plugins/summernoteStyles")
    @Styles.Render("~/bundles/css/datatables")
}

@section Scripts {
    @Scripts.Render("~/plugins/selectize")
    @Scripts.Render("~/bundles/datatables")
    @Scripts.Render("~/bundles/post/edit")

    <script type="text/javascript">
    var gid = @Model.Group.GroupId;
    var knownGroups = [''];

    var changeGroup = function () {
        swal({
            title: "Changing groups resets the score.",
            text: "Are you sure you want to move this post?",
            icon: "warning",
            buttons: true,
            dangerMode: true
        }).then(function (willMove) {
            if (willMove) {
                $("#postGroup").autocomplete({
                    autoFocus: true,
                    source: function (request, response) {
                        $.ajax({
                            async: true,
                            url: "/Group/GetGroups",
                            type: "POST",
                            dataType: "json",
                            data: { prefix: request.term },
                            success: function (data) {
                                knownGroups = data;
                                response($.map(data, function (item) {
                                    return { label: item.GroupName, value: item.GroupName };
                                }))
                            }
                        })
                    },
                    select: function (event, ui) {
                        // if user clicked
                    },
                    change: function (event, ui) {
                        var gn = $("#postGroup").val();
                        if (typeof knownGroups === 'undefined' || knownGroups.length == 0) {
                            // variable is undefined
                            $("#postGroup").addClass('is-invalid');
                        }
                        else {
                            if (knownGroups.findIndex(function (i) { return i.GroupName == gn; }) >= 0) {
                                $("#postGroup").removeClass('is-invalid');
                                gid = knownGroups[knownGroups.findIndex(function (i) { return i.GroupName == gn })].GroupId;
                            }
                            else {
                                $("#postGroup").addClass('is-invalid');
                            }
                        }
                    }
                });

                $('#changeGroupBtn').hide();
                $('#editGroup').show();
            } else {
                console.log("cancelled move");
            }
        });

        return false;
    };

    var draftsTable = {};
    $(document).ready(function () {
        draftsTable = $('#draftsTable').DataTable({
            "searching": true,
            "lengthChange": false,
            "pageLength": 10,
            "processing": true,
            "serverSide": true,
            "ajax": {
                type: "POST",
                contentType: "application/json",
                url: "/Post/GetDrafts",
                data: function (d) {
                    return JSON.stringify(d);
                }
            },
            "columns": [
                { "data": "Title", "orderable": true },
                {
                    "data": null,
                    "orderable": true,
                    "mRender": function (data, type, row) {
                        return "<a href='/Group/GroupDetail/" + data.GroupId + "'>" + data.Group + "</a>";
                    }
                },
                { "data": "Time", "orderable": false },
                {
                    "data": null,//"Type",
                    "orderable": false,
                    "mRender": function (data, type, row) {
                        return "<button class='btn btn-sm btn-primary' onclick=loadpost(" + data.PostId + ")>Load</button> <button class='btn btn-sm btn-danger' onclick=del(" + data.PostId + ")>Delete</button>"//"<a href='" + data.URL + "'>" + data.Type + "</a>";
                    }
                }
            ],
        });

        $('.click2edit').summernote({
            toolbarContainer: '#editorToolbar',
            otherStaticBar: '.navbar',
            callbacks: {
                onImageUpload: function (files) {
                    that = $(this);
                    sendFile(files[0], that);
                }
            },
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'italic', 'underline', 'clear', 'strikethrough', 'superscript', 'subscript']],
                ['fontname', ['fontname']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture', 'videoAttributes']],
                ['view', ['fullscreen', 'codeview']]
            ],
            focus: true,
            hint: {
                match: /\B@@(\w*)$/,
                search: function (keyword, callback) {
                    if (!keyword.length) return callback();
                    var msg = JSON.stringify({ 'searchstr': keyword.toString() })
                    $.ajax({
                        async: true,
                        url: '/Comment/GetMentions',
                        type: 'POST',
                        contentType: "application/json; charset=utf-8",
                        dataType: 'json',
                        data: msg,
                        error: function () {
                            callback();
                        },
                        success: function (res) {
                            callback(res.users);
                        }
                    });
                },
                content: function (item) {
                    return $("<span class='badge badge-info userhint'>").html('@@' + item)[0];
                }
            }
        });
    });
    </script>
}
