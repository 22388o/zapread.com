@{
    var url = string.Format(
        "/Img/QR?qr={0}",
        @Uri.EscapeDataString("02cda8c01b2303e91bec74c43093d5f1c4fd42a95671ae27bf853d7dfea9b78c06@lightning.zapread.com:9735"));
}

<div class="modal fade" id="voteModal" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="voteModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="voteModalTitle">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card ">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="row">
                                    <div class="col-5">
                                        <span> Pay </span>
                                        <input type="number" id="voteValueAmount" placeholder="Amount" class="form-control font-bold" aria-label="Amount">
                                        <small class="text-muted">Satoshi</small>
                                    </div>
                                    <div class="col-5 text-right">
                                        <span> Balance </span>
                                        <h2 class="font-bold"><span id="userVoteBalance">0</span> </h2>
                                        <small class="text-muted">Satoshi</small>
                                    </div>
                                    <div class="col-2">
                                        <i class="fa fa-bolt fa-5x"></i>
                                    </div>
                                </div>
                                <h2 class="font-bold"><span id="payAmount" style="display:none"></span></h2>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <div class="input-group mb-3" id="depositMemoValue">
                            </div>
                        </div>

                        <img id="voteDepositQR" src="~/Content/FFFFFF-0.png" class="img-fluid" />

                        <div class="input-group mb-3" id="voteDepositInvoice" style="display:none">
                            <div class="input-group-prepend">
                                <a href="lightning:xxx" id="lnDepositInvoiceLink" class="btn btn-primary" role="button" aria-pressed="true"><span class="fa fa-bolt"></span></a>
                            </div>
                            <input type="text" id="voteDepositInvoiceInput" class="form-control" placeholder="invoice" aria-label="invoice" aria-describedby="basic-addon2">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" onclick="copyToClipboard(this,'voteDepositInvoiceInput');"><span class="fa fa-copy"></span> Copy</button>
                            </div>
                            <div class="col-md-2 pull-right">
                                <!-- Small modal -->
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target=".vote-modal"><i class="fa fa-qrcode"></i></button>

                                <div class="modal fade vote-modal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <img src="@url" class="img-fluid" />
                                            <br />
                                            <textarea class="form-control" value="" readonly="readonly" rows="3">02cda8c01b2303e91bec74c43093d5f1c4fd42a95671ae27bf853d7dfea9b78c06@lightning.zapread.com:9735</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-info" id="voteDepositInvoiceFooter">
                        Click vote to confirm.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="checkInvoicePaid(this);" id="btnCheckLNVote" type="button" class="btn btn-info btn-ln-checkPayment" style="display:none;" data-invoice-element="voteDepositInvoiceInput" data-spin-element="spinCheckPaymentVote">Check Payment <i id="spinCheckPaymentVote" class="fa fa-circle-o-notch fa-spin" style="display:none"></i></button>
                <button onclick="onVote(this);" id="voteOkButton" type="button" class="btn btn-primary">Vote</button>
                <button onclick="onCancelVote(this);" type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

@Html.Script(
@<script type="text/javascript">

    var userVote = { id: 0, d: 0, t: 0, amount: 1, tx: 0, b: 0 }
    var userTip = { username: "", amount: 1 }
    var isTip = false;
    var voteReadyEvent = new Event('voteReady');

     $(document).ready(function () {
         var userdefaultvote = '1';
         $('#payAmount').html(userdefaultvote);
         $('#voteValueAmount').val(userdefaultvote);

         var userBalance = userVote.b;
         $.get("/Account/GetBalance", function (data, status) {
             userBalance = parseFloat(data.balance);
             $('#userVoteBalance').html(data.balance);
             ub = data.balance;
             //userVote.b = ub;
             $(".userBalanceValue").each(function (i, e) {
                 $(e).html(data.balance);
             });
         });

         $('#userVoteBalance').html(userBalance);
         $.ajax({
             type: "POST",
             url: "/Account/UserBalance/",
             contentType: "application/json; charset=utf-8",
             dataType: "json",
             success: function (response) {
                 ub = response.balance;
                 $('#userVoteBalance').html(response.balance);
                 userVote.b = ub;
             },
             failure: function (response) {
                 //alert("failure " + JSON.stringify(response));
             },
             error: function (response) {
                 //alert("error " + JSON.stringify(response));
             }
         });

         // If the user updates the amount
         $('#voteValueAmount').on('input', function () {
             amt = $(this).val()
             userVote.amount = amt;
             userTip.amount = amt;
             if (parseInt(userVote.amount) > parseInt(userVote.b)) {
                 $('#voteDepositInvoiceFooter').html('Please pay lightning invoice.');
                 $("#voteDepositInvoiceFooter").removeClass("bg-success");
                 $("#voteDepositInvoiceFooter").removeClass("bg-error");
                 $("#voteDepositInvoiceFooter").addClass("bg-info");
                 $("#voteOkButton").html('Get Invoice');
             }
             else {
                 if (isTip) {
                     $('#voteDepositInvoiceFooter').html("Click tip to confirm.");
                     $("#voteOkButton").html('Tip');
                 }
                 else {
                     $('#voteDepositInvoiceFooter').html("Click vote to confirm.");
                     $("#voteOkButton").html('Vote');
                 }
                 $("#voteDepositInvoiceFooter").removeClass("bg-success");
                 $("#voteDepositInvoiceFooter").removeClass("bg-error");
                 $("#voteDepositInvoiceFooter").addClass("bg-info");
             }
         });
         document.dispatchEvent(voteReadyEvent);
     });

    // User tip
    // user = name of user
    // uid = id of user
    var tip = function (user, uid) {
        isTip = true;
        $('#voteModalTitle').html("Tip " + user);
        $.get("/Account/GetBalance", function (data, status) {
            $('#userVoteBalance').html(data.balance);
            userBalance = parseFloat(data.balance);
            $(".userBalanceValue").each(function (i, e) {
                $(e).html(data.balance);
            });
            userVote.id = uid;

            /* This is done here prior to showing */
            if (userVote.amount > userBalance) {
                $('#voteDepositInvoiceFooter').html('Please pay lightning invoice.');
                $("#voteDepositInvoiceFooter").removeClass("bg-success");
                $("#voteDepositInvoiceFooter").removeClass("bg-error");
                $("#voteDepositInvoiceFooter").addClass("bg-info");
                $("#voteOkButton").html('Get Invoice');
            }
            else {
                $('#voteDepositInvoiceFooter').html("Click tip to confirm.");
                $("#voteDepositInvoiceFooter").removeClass("bg-success");
                $("#voteDepositInvoiceFooter").removeClass("bg-error");
                $("#voteDepositInvoiceFooter").addClass("bg-info");
                $("#voteOkButton").html('Tip');
            }

            /* Prepare vote modal without an invoice, and show it.*/
            $("#voteDepositQR").hide();
            $("#voteDepositInvoice").hide();
            $('#voteModal').modal('show');
        });
    };

    var doTip = function (id, amount, tx) {
        // id : the user receiving the tip
        // amount : the amount of the tip
        // tx : txid if the tip is anonymous

        var data = JSON.stringify({ 'id': id, 'amount': parseInt(amount), 'tx': tx });
        var url = '/Manage/TipUser';
        console.log(data);
        $.ajax({
            data: data.toString(),
            type: 'POST',
            url: url,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (response.Result == "Success") {
                    
                    $('#voteModal').modal('hide');

                    // Update user balance displays
                    $.get("/Account/GetBalance", function (data, status) {
                        $(".userBalanceValue").each(function (i, e) {
                            $(e).html(data.balance);
                        });
                    });
                }
                else {
                    $("#voteDepositInvoiceFooter").removeClass("bg-success");
                    $("#voteDepositInvoiceFooter").removeClass("bg-info");
                    $("#voteDepositInvoiceFooter").addClass("bg-error");
                    $("#voteDepositInvoiceFooter").html(Result.Message);
                    $("#voteDepositInvoiceFooter").show();
                }
            }
        });
        isTip = false;
    };
</script>
)
